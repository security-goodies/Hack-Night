/*
 *  Part 4 - Changing Program Execution Flow by Chaining Together Existing
 *           Code from the Program with a Stack Based Buffer Overflow
 *  Task - Make the program execute certain functions in a sequential order
 *  */

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define DEBUG 1

char command[8];
void *function;

void printStack(char **stack, void* returnAddr) {
    char **stackAddress;

    printf("Our stack looks like\n");
    for (stackAddress = stack; stackAddress < stack + 0x20; stackAddress++) {
        printf("%p : %p", stackAddress, *stackAddress);
        if ((void *) *stackAddress == returnAddr)
            printf(" <-- Saved EIP (return address)");
        printf("\n");
    }
    printf("\n");
}

void printDebugInfo(void *ret, char **stack) {
    // Print the return address of the function we are in
    printf("Our return address is: %p\n", ret);

    // Print what our stack looks like right now
    printStack(stack, ret);
}

// Functions you should have in your ROP chain
void setCommand() {
    strcpy(command, "/bin/sh\0");
}

void setFunction() {
    function = system;
}

void doTheThing() {
    ((void(*)()) function)(command);
}

void returnOrientedProgramming() {
    char buffer[0];
    char **stack;

    memset(buffer, 0, sizeof(buffer));

    if (DEBUG) {
        puts("Entered function: returnOrientedProgramming\n");
        
        printf("setCommand is at: %p\n", setCommand);
        printf("setFunction is at: %p\n", setFunction);
        printf("doTheThing is at: %p\n", doTheThing);

        void *ret =  __builtin_return_address(0);
        stack = (char **) (&stack);
        printDebugInfo(ret, stack);
    }

    // Can you make the next three lines alter the return address?
    printf("What do you want me to chain for you?: "); fflush(stdout);
    fgets(buffer, 0x100, stdin);
    printf("\n");

    if (DEBUG) {
        void *ret =  __builtin_return_address(0);
        stack = (char **) (&stack);
        printDebugInfo(ret, stack);

        puts("Leaving function: returnOrientedProgramming");
    }
}

void returnOrientedProgrammingWithoutDebugInfo() {
    char buffer[0];

    memset(buffer, 0, sizeof(buffer));

    // Can you make the next three lines alter the return address?
    printf("What do you want me to chain for you?: "); fflush(stdout);
    fgets(buffer, 0x100, stdin);

    printf("\n");
}

int main() {
    returnOrientedProgramming();

    puts("I don't think you ropped enough");

    return 0;
}


