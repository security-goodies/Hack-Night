/*
 *  Part 2 - Changing Program Execution Flow with Stack Based
 *           Buffer Overflow
 *  Task - Make the program execute code that it would otherwise
 *         would not have executed
 *  */

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define DEBUG 1
#define BUFF_SIZE 64

void printStack(char **stack, void* returnAddr, char* startBuffer, char* endBuffer) {
    char **stackAddress;

    printf("Our stack looks like\n");
    for (stackAddress = stack; stackAddress < stack + 0x10; stackAddress++) {
        printf("%p : %p", stackAddress, *stackAddress);
        if ((void *) *stackAddress == returnAddr)
            printf(" <-- Saved EIP (return address)");
        if ((char *) stackAddress == startBuffer)
            printf(" <-- Start of buffer");
        if ((char *) stackAddress == endBuffer)
            printf(" <-- End of buffer");
        printf("\n");
    }
    printf("\n");
}

void printDebugInfo(void *ret, char **stack, char* sBuf, char* eBuf) {
    // Print the return address of the function we are in
    printf("Our return address is: %p\n", ret);

    // Print what our stack looks like right now
    printStack(stack, ret, sBuf, eBuf);
}

void doSomethingDifferent() {
    FILE *fp;
    char flag[BUFF_SIZE];

    puts("Nice! You did something different for a change");

    fp = fopen("flag", "r");
    if(!fp){
        printf("You won!, sadly the flag is nowhere to be seen\n");
        exit(1);
    }
    fscanf(fp, "%s", flag);
    printf("Your flag is: %s\n", flag);
    exit(0);
}

void doSomething() {
    int deadbeef = 0xdeadbeef;
    int cafebabe = 0xcafebabe;
    char buffer[BUFF_SIZE];
    char **stack;

    memset(buffer, 0, sizeof(buffer));

    if (DEBUG) {
        puts("Entered function: doSomething\n");
        // Let the person know where the doSomethingDifferent function is
        // located
        printf("The doSomethingDifferent function is located at: %p\n", doSomethingDifferent);

        void *ret =  __builtin_return_address(0);
        stack = (char **) (&stack);
        printDebugInfo(ret, stack, buffer, buffer + BUFF_SIZE);
    }

    // Can you make the next three lines alter the return address?
    printf("Send me something special!: "); fflush(stdout);
    read(0, buffer, 512);
    printf("\n");

    if (DEBUG) {
        void *ret =  __builtin_return_address(0);
        stack = (char **) (&stack);
        printDebugInfo(ret, stack, buffer, buffer + BUFF_SIZE);

        puts("Leaving function: doSomething");
    }
}

void doSomethingWithoutDebugInfo() {
    int deadbeef = 0xdeadbeef;
    int cafebabe = 0xcafebabe;
    char buffer[BUFF_SIZE];

    memset(buffer, 0, sizeof(buffer));

    // Can you make the next three lines alter the return address?
    printf("Send me something special!: "); fflush(stdout);
    fgets(buffer, deadbeef - cafebabe, stdin);

    printf("\n");
}

int main() {
    doSomething();

    puts("I don't think you did anything different :C");

    return 0;
}

