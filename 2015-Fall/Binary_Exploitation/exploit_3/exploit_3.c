/*
 *  Part 3 - Changing Program Execution Flow by Returning to User Controlled
 *           data with a Stack Based Buffer Overflow
 *  Task - Make the program execute code (shellcode) by tricking the program
 *         into thinking that your input is a function pointer
 *  */

#include <stdio.h>
#include <unistd.h>
#include <string.h>

#define DEBUG 1
#define BUFF_SIZE 128

void printStack(char **stack, void* returnAddr, char* startBuffer, char* endBuffer) {
    char **stackAddress;

    printf("Our stack looks like\n");
    for (stackAddress = stack; stackAddress < stack + 0x20; stackAddress++) {
        printf("%p : %p", stackAddress, *stackAddress);
        if ((void *) *stackAddress == returnAddr)
            printf(" <-- Saved EIP (return address)");
        if ((char *) stackAddress == startBuffer)
            printf(" <-- Start of buffer");
        if ((char *) stackAddress == endBuffer)
            printf(" <-- End of buffer");
        printf("\n");
    }
    printf("\n");
}

void printDebugInfo(void *ret, char **stack, char* sBuf, char* eBuf) {
    // Print the return address of the function we are in
    printf("Our return address is: %p\n", ret);

    // Print what our stack looks like right now
    printStack(stack, ret, sBuf, eBuf);
}

void gimmeSomeShellcode() {
    char buffer[BUFF_SIZE];
    char **stack;

    memset(buffer, 0, sizeof(buffer));

    if (DEBUG) {
        puts("Entered function: gimmeSomeShellcode\n");

        void *ret =  __builtin_return_address(0);
        stack = (char **) (&stack);
        printDebugInfo(ret, stack, buffer, buffer + BUFF_SIZE);
    }

    // Can you make the next three lines alter the return address?
    printf("Send whatever you want: "); fflush(stdout);
    fgets(buffer, 0x100, stdin);
    printf("\n");

    if (DEBUG) {
        void *ret =  __builtin_return_address(0);
        stack = (char **) (&stack);
        printDebugInfo(ret, stack, buffer, buffer + BUFF_SIZE);

        puts("Leaving function: gimmeSomeShellcode");
    }
}

void gimmeSomeShellcodeWithoutDebugInfo() {
    char buffer[BUFF_SIZE];

    memset(buffer, 0, sizeof(buffer));

    // Can you make the next three lines alter the return address?
    printf("Send whatever you want: "); fflush(stdout);
    fgets(buffer, 0x100, stdin);

    printf("\n");
}

int main() {
    gimmeSomeShellcode();

    puts("I don't think you poped a shell :C");

    return 0;
}

